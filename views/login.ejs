<%- include('partials/header') %>

<div class="container" style="max-width:980px; margin-top:40px;">
  <div class="row justify-content-center">
    <div class="col-11 col-sm-8 col-md-6">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h4 class="mb-3 text-center">Masuk â€” WA Panel</h4>

          <form id="formLogin" autocomplete="off">
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input name="username" class="form-control" required autofocus>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input name="password" type="password" class="form-control" required>
            </div>
            <div class="d-grid">
              <button id="btnLogin" class="btn btn-primary" type="submit">Masuk</button>
            </div>
          </form>

          <hr>
          <small class="text-muted">Hubungi admin jika belum punya akun.</small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $("#formLogin").on("submit", async function(e){
    e.preventDefault();
    const username = this.username.value.trim();
    const password = this.password.value;

    // Tombol loading state
    const btn = $("#btnLogin").prop("disabled", true).text("Memproses...");

    try {
      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ username, password })
      });

      // Jika API tidak mengembalikan JSON valid
      if (!res.ok) {
        toastr.error("Gagal login, server mengembalikan error");
        btn.prop("disabled", false).text("Masuk");
        return;
      }

      const j = await res.json();

      if (!j.ok) {
        toastr.error(j.message || j.error || "Login gagal");
        btn.prop("disabled", false).text("Masuk");
        return;
      }

      // Simpan token
      localStorage.setItem("token", j.token);
      toastr.success("Login berhasil, mengalihkan halaman...");

      // Redirect sesuai role
      setTimeout(() => {
        if (j.user.role === "admin") {
          window.location.href = "/wa";
        } else {
          window.location.href = "/wa-lite";
        }
      }, 800);

    } catch (err) {
      toastr.error("Gagal koneksi ke server");
      console.error(err);
      btn.prop("disabled", false).text("Masuk");
    }
  });
</script>
